<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TipsterAI - Pronostici</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Pronostici sportivi basati su intelligenza artificiale">
    <meta name="theme-color" content="#7c3aed">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TipsterAI">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.webmanifest">

    <!-- Favicon & Icons -->
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/app.css?v=3.5.3">
</head>

<body class="text-white">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="text-white text-2xl font-bold mb-4 animate-pulse">TipsterAI</div>
            <div class="text-blue-300 text-sm">Caricamento...</div>
        </div>
    </div>

    <!-- Login/Register Screen (hidden after login) -->
    <div id="login-container"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-40 px-4">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full text-gray-800">
            <h2 id="auth-title" class="text-2xl font-bold mb-6 text-center">Accedi a TipsterAI</h2>

            <!-- Toggle Login/Register -->
            <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
                <button id="toggle-login"
                    class="flex-1 py-2 rounded-lg font-semibold bg-purple-600 text-white transition">
                    Accedi
                </button>
                <button id="toggle-register" class="flex-1 py-2 rounded-lg font-semibold text-gray-600 transition">
                    Registrati
                </button>
            </div>

            <form id="auth-form" class="space-y-4">
                <!-- Nickname field - only visible during registration -->
                <div id="name-field" class="hidden">
                    <label class="block text-sm font-medium mb-1">Nickname</label>
                    <input type="text" id="user-name"
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
                        placeholder="Mario">
                    <div class="text-xs text-gray-500 mt-1">euGENIO ti chiamer√† cos√¨!</div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="email" required
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="password" required minlength="6"
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                    <div class="text-xs text-gray-500 mt-1">Minimo 6 caratteri</div>
                </div>
                <div id="auth-error" class="text-red-500 text-sm hidden"></div>
                <button type="submit" id="auth-submit-btn"
                    class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 rounded-lg font-bold hover:opacity-90">
                    Accedi
                </button>
            </form>

            <!-- Forgot Password Link (only visible during login) -->
            <div id="forgot-password-link" class="text-center mt-4">
                <a href="#" onclick="resetPassword(); return false;"
                    class="text-sm text-purple-600 hover:text-purple-800 font-semibold">
                    Password dimenticata?
                </a>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden">
        <!-- Top Bar -->
        <div class="bg-gradient-to-r from-purple-700 to-blue-700 shadow-lg sticky top-0 z-40">
            <div class="container mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="logo.png" alt="TipsterAI" class="h-10 w-auto max-w-24 object-contain">
                    <div>
                        <h1 class="text-2xl font-black">TipsterAI</h1>
                        <p id="user-nickname-header" class="text-xs text-purple-200"></p>
                    </div>
                </div>
                <button id="logout-btn" class="text-sm hover:text-yellow-300 transition">
                    <i class="fa-solid fa-right-from-bracket mr-1"></i> Esci
                </button>
            </div>
        </div>

        <!-- Strategies Page -->
        <div id="page-strategies" class="page active container mx-auto px-4 pb-24">
            <!-- Stats Dashboard (Moved inside strategies page) -->
            <div id="stats-dashboard" class="mb-6">
                <!-- Riga 1: Box grande totale -->
                <div class="stat-card rounded-xl p-4 text-center mb-3">
                    <div class="text-gray-700 text-xs font-semibold mb-1">Pronostici da agosto 2025</div>
                    <div id="stat-total" class="text-3xl font-black text-blue-800">-</div>
                </div>

                <!-- Riga 2: 3 box piccoli -->
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div class="stat-card rounded-xl p-3 text-center">
                        <div class="text-gray-700 text-[10px] font-semibold mb-1">Pronostici<br>VINTI</div>
                        <div id="stat-wins" class="text-xl font-black text-green-600">-</div>
                    </div>
                    <div class="stat-card rounded-xl p-3 text-center">
                        <div class="text-gray-700 text-[10px] font-semibold mb-1">Pronostici<br>PERSI</div>
                        <div id="stat-losses" class="text-xl font-black text-red-600">-</div>
                    </div>
                    <div class="stat-card rounded-xl p-3 text-center">
                        <div class="text-gray-700 text-[10px] font-semibold mb-1">WINRATE</div>
                        <div id="stat-winrate" class="text-xl font-black text-green-600">-</div>
                    </div>
                </div>

                <div class="stat-card rounded-lg px-4 py-2 text-center">
                    <div class="text-gray-600 text-xs">
                        <i class="fa-solid fa-sparkles mr-1"></i>
                        Aggiornata per nuovi Pronostici: <span id="last-update" class="font-semibold">-</span>
                    </div>
                </div>
            </div>

            <h2 class="text-2xl font-bold mb-4 text-center">üìä Seleziona una Strategia</h2>
            <div id="strategies-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <!-- Populated dynamically -->
            </div>
        </div>

        <!-- Ranking Page -->
        <div id="page-ranking" class="page container mx-auto px-4 pb-24">
            <div class="flex items-center justify-between mb-4">
                <button id="back-to-strategies" class="text-sm hover:text-yellow-300">
                    <i class="fa-solid fa-arrow-left mr-1"></i> Tutte le Strategie
                </button>
                <h2 id="strategy-title" class="text-xl font-bold">-</h2>
            </div>

            <!-- Sorting Toggle -->
            <div class="flex gap-2 mb-4">
                <button id="sort-by-score"
                    class="flex-1 bg-purple-600 text-white py-2 px-4 rounded-lg font-semibold text-sm">
                    üìä Per Ranking
                </button>
                <button id="sort-by-time"
                    class="flex-1 bg-gray-700 text-gray-300 py-2 px-4 rounded-lg font-semibold text-sm">
                    üïê Per Orario
                </button>
            </div>

            <div id="matches-container" class="space-y-4">
                <!-- Populated dynamically -->
            </div>
        </div>


        <!-- History Page (7-Day Track Record) -->
        <div id="page-history" class="page container mx-auto px-4 pb-24">
            <div class="mb-6">
                <h2 class="text-3xl font-bold mb-2">üìÖ Ultimi 7 Giorni</h2>
                <p class="text-gray-400 text-sm">Track record completo delle performance</p>
            </div>

            <!-- Tab Switch -->
            <div class="flex gap-2 mb-4">
                <button id="history-tab-pronostici"
                    class="flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all bg-gradient-to-r from-purple-600 to-blue-600 text-white shadow-lg">
                    üéØ Pronostici
                </button>
                <button id="history-tab-trading"
                    class="flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all bg-gray-700 text-gray-300 hover:bg-gray-600">
                    üìà Trading
                </button>
            </div>

            <!-- Pronostici History (default visible) -->
            <div id="history-list" class="space-y-3">
                <!-- Populated dynamically with date cards -->
            </div>

            <!-- Trading History (hidden by default) -->
            <div id="trading-history-list" class="space-y-3 hidden">
                <!-- Populated dynamically with trading date cards -->
            </div>
        </div>

        <!-- My Matches Page -->
        <div id="page-my-matches" class="page container mx-auto px-4 pb-24">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold">‚≠ê Le Mie Partite</h2>
                <button id="delete-all-matches-btn"
                    class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold text-sm hover:bg-red-700 transition">
                    <i class="fa-solid fa-trash mr-1"></i> Cancella Tutte
                </button>
            </div>

            <!-- Sorting Toggle for My Matches -->
            <div class="flex gap-2 mb-4">
                <button id="my-matches-sort-score"
                    class="flex-1 bg-purple-600 text-white py-2 px-4 rounded-lg font-semibold text-sm">
                    üìä Per Ranking
                </button>
                <button id="my-matches-sort-time"
                    class="flex-1 bg-gray-700 text-gray-300 py-2 px-4 rounded-lg font-semibold text-sm">
                    üïê Per Orario
                </button>
            </div>

            <div id="my-matches-container" class="space-y-4">
                <!-- Populated dynamically with Betting Favorites -->
            </div>
        </div>

        <!-- Account Page -->
        <div id="account-page" class="page container mx-auto px-4 py-6 pb-24">
            <h2 class="text-2xl font-bold mb-6 text-white">Il Mio Account</h2>

            <!-- Profile Card -->
            <div class="stat-card rounded-xl p-6 mb-4">
                <div class="flex items-center gap-4 mb-6">
                    <div id="account-avatar"
                        class="bg-gradient-to-br from-purple-600 to-blue-600 w-16 h-16 rounded-full flex items-center justify-center text-white text-2xl font-black">
                        ?
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800" id="account-name">-</h3>
                        <p class="text-gray-600 text-sm" id="account-email">-</p>
                    </div>
                </div>

                <!-- Edit Nickname Form -->
                <form id="edit-nickname-form" class="mb-4">
                    <label class="block font-semibold mb-2 text-sm text-gray-800">Cambia Nickname</label>
                    <input type="text" id="edit-nickname-input"
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none text-gray-800"
                        placeholder="Nuovo nickname" />
                    <button type="submit"
                        class="mt-3 bg-purple-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-purple-700 transition">
                        Salva Nickname
                    </button>
                </form>
            </div>

            <!-- Subscription Card -->
            <div class="stat-card rounded-xl p-6">
                <h3 class="font-bold mb-3 text-lg text-gray-800">Abbonamento</h3>
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-gray-700">Piano: <strong id="subscription-plan"
                                class="text-purple-600">Free</strong></div>
                        <p class="text-xs text-gray-500 mt-1">Registrato il <span id="account-created">-</span></p>
                    </div>
                    <button
                        class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-4 py-2 rounded-lg font-bold text-sm hover:opacity-90 transition">
                        ‚≠ê Passa a PRO
                    </button>
                </div>
            </div>

            <!-- Telegram Notifications Card -->
            <div class="stat-card rounded-xl p-6 mt-4">
                <h3 class="font-bold mb-3 text-lg text-gray-800 flex items-center gap-2">
                    <i class="fa-brands fa-telegram text-blue-500"></i> Notifiche Telegram
                </h3>

                <!-- Not Linked State -->
                <div id="telegram-not-linked" class="space-y-3">
                    <p class="text-sm text-gray-600">Collega Telegram per ricevere notifiche live sui tuoi preferiti!
                    </p>
                    <div class="flex items-center gap-2">
                        <button id="generate-telegram-code-btn"
                            class="bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-blue-600 transition flex items-center gap-2">
                            <i class="fa-solid fa-link"></i> Genera Codice
                        </button>
                    </div>

                    <!-- Code Display (hidden initially) -->
                    <div id="telegram-code-display"
                        class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mt-3">
                        <p class="text-sm text-gray-700 mb-2">Il tuo codice di collegamento:</p>
                        <div class="flex items-center gap-2">
                            <span id="telegram-link-code"
                                class="text-2xl font-mono font-bold text-blue-600 tracking-wider"></span>
                            <button id="copy-telegram-code" class="text-blue-500 hover:text-blue-700">
                                <i class="fa-solid fa-copy"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            1. Apri <a href="https://t.me/TipsterAI_Live_Bot" target="_blank"
                                class="text-blue-500 underline">@TipsterAI_Live_Bot</a> su Telegram<br>
                            2. Invia: <code
                                class="bg-gray-200 px-1 rounded">/start <span class="telegram-code-copy">CODICE</span></code>
                        </p>
                    </div>
                </div>

                <!-- Linked State -->
                <div id="telegram-linked" class="hidden space-y-3">
                    <div class="flex items-center gap-2 text-green-600">
                        <i class="fa-solid fa-check-circle"></i>
                        <span class="font-semibold">Collegato!</span>
                        <span id="telegram-username" class="text-gray-500 text-sm"></span>
                    </div>

                    <!-- Notification Preferences -->
                    <div class="space-y-2 mt-4">
                        <p class="text-sm font-semibold text-gray-700">Notifiche attive:</p>
                        <label class="flex items-center gap-2 text-sm text-gray-600">
                            <input type="checkbox" id="notify-kickoff" checked class="rounded text-blue-500">
                            ‚öΩ Inizio partita
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-600">
                            <input type="checkbox" id="notify-goal" checked class="rounded text-blue-500">
                            ü•Ö Goal segnato
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-600">
                            <input type="checkbox" id="notify-result" checked class="rounded text-blue-500">
                            üèÅ Fine partita
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-600">
                            <input type="checkbox" id="notify-live" checked class="rounded text-blue-500">
                            üì° Notifiche Live (Trading)
                        </label>
                    </div>

                    <button id="unlink-telegram-btn"
                        class="text-red-500 text-sm hover:underline mt-2 flex items-center gap-1">
                        <i class="fa-solid fa-unlink"></i> Scollega Telegram
                    </button>
                </div>
            </div>
        </div>

        <!-- Trading Sportivo Page -->
        <div id="page-trading-sportivo" class="page container mx-auto px-4 pb-24">
            <!-- Header & Date Nav -->
            <div class="mb-6">
                <h2 class="text-2xl font-bold mb-2">üéØ Trading Sportivo</h2>
                <p class="text-sm text-gray-400 mb-4">Le migliori partite selezionate per trading sportivo</p>

                <!-- Date Navigation -->
                <div class="flex items-center justify-between bg-gray-800 rounded-lg p-3 mb-4">
                    <button id="trading-date-prev" class="text-gray-400 hover:text-white transition">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <div class="text-center">
                        <div id="trading-selected-date-display" class="font-bold text-white text-sm">Oggi</div>
                        <div id="trading-date-indicator" class="text-[10px] text-gray-500 mt-0.5">-</div>
                    </div>
                    <button id="trading-date-next" class="text-gray-400 hover:text-white transition">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>

                <!-- Dashboard Filters -->
                <div class="flex gap-2 mb-4 bg-gray-900 p-1 rounded-xl">
                    <button id="filter-trading-all"
                        class="flex-1 py-2 px-3 rounded-lg font-bold text-xs transition-all bg-gray-800 text-white shadow-lg">
                        TUTTE
                    </button>
                    <button id="filter-trading-live"
                        class="flex-1 py-2 px-3 rounded-lg font-bold text-xs transition-all bg-transparent text-gray-500 hover:bg-gray-800 flex items-center justify-center gap-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span> LIVE
                    </button>
                    <button id="filter-trading-favs"
                        class="flex-1 py-2 px-3 rounded-lg font-bold text-xs transition-all bg-transparent text-gray-500 hover:bg-gray-800 flex items-center justify-center gap-1">
                        <i class="fa-solid fa-star text-yellow-500 text-[10px]"></i> MIE
                    </button>
                </div>
            </div>

            <!-- Trading Cards Container -->
            <div id="trading-cards-container" class="space-y-4">
                <!-- Populated dynamically -->
            </div>

            <!-- Empty State -->
            <div id="trading-empty" class="hidden text-center py-12">
                <i class="fa-solid fa-chart-line text-6xl text-gray-600 mb-4"></i>
                <p class="text-gray-400">Nessuna trading pick per questa data</p>
                <p class="text-sm text-gray-500 mt-2">Le picks vengono generate dall'admin per ogni giornata</p>
            </div>
        </div>

        <!-- Serie A Live Page -->
        <div id="page-serie-a" class="page container mx-auto px-4 pb-24">
            <div class="mb-6">
                <div class="flex items-center gap-3 mb-2">
                    <img src="logo_serie_a.png" alt="Serie A" class="h-10 w-auto">
                    <h2 class="text-2xl font-black">Serie A Live</h2>
                </div>
                <p class="text-sm text-purple-200">Intelligence in tempo reale per tutto il campionato</p>
            </div>

            <div id="serie-a-live-container" class="space-y-4">
                <!-- Populated with live match widgets -->
                <div class="text-center py-12 text-gray-300">
                    <i class="fa-solid fa-satellite-dish text-5xl mb-4 opacity-50"></i>
                    <p>In attesa delle partite di oggi...</p>
                </div>
            </div>
        </div>

        <!-- Bottom Nav -->
        <div class="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-700 flex justify-around py-3 z-50">
            <button data-page="strategies" class="nav-btn flex flex-col items-center text-purple-400 transition">
                <i class="fa-solid fa-list text-2xl mb-1"></i>
                <span class="text-xs font-semibold">Strategie</span>
            </button>
            <button data-page="history"
                class="nav-btn flex flex-col items-center text-gray-400 hover:text-green-400 transition">
                <i class="fa-solid fa-calendar-days text-2xl mb-1"></i>
                <span class="text-xs font-semibold">Ultimi 7 Giorni</span>
            </button>
            <button data-page="my-matches"
                class="nav-btn flex flex-col items-center text-gray-400 hover:text-yellow-400 transition">
                <i class="fa-solid fa-star text-2xl mb-1"></i>
                <span class="text-xs font-semibold">Mie Partite</span>
            </button>
            <button data-page="trading-sportivo"
                class="nav-btn flex flex-col items-center text-gray-400 hover:text-orange-400 transition">
                <i class="fa-solid fa-chart-line text-2xl mb-1"></i>
                <span class="text-xs font-semibold">Trading</span>
            </button>
            <button data-page="serie-a"
                class="nav-btn flex flex-col items-center text-gray-400 hover:text-blue-300 transition">
                <img src="logo_serie_a.png" class="h-6 w-auto mb-1 opacity-80" alt="Serie A">
                <span class="text-xs font-semibold">Serie A</span>
            </button>
            <button data-page="account"
                class="nav-btn flex flex-col items-center text-gray-400 hover:text-blue-400 transition">
                <i class="fa-solid fa-user text-2xl mb-1"></i>
                <span class="text-xs font-semibold">Account</span>
            </button>
        </div>
    </div>

    <script>
        // ==================== CREDENZIALI FIREBASE E GEMINI ====================
        // NEW: TispsterAI-APP (Public App Database)
        window.firebaseConfig = {
            apiKey: "AIzaSyD7aXUbEshUFsUnpIDR3ZO1tAIgMsb_zpc",
            authDomain: "tispsterai-app.firebaseapp.com",
            projectId: "tispsterai-app",
            storageBucket: "tispsterai-app.firebasestorage.app",
            messagingSenderId: "166289799388",
            appId: "1:166289799388:web:d8b31f2c24eb1d75f11c19"
        };
        // Gemini API Key is now handled securely server-side via Cloud Functions.
        // No more direct client-side keys.
    </script>

    <!-- AI CHATBOT WIDGET -->
    <div id="ai-chat-widget" class="fixed bottom-20 right-6 z-50 flex flex-col items-end font-sans">
        <!-- Chat Window -->
        <div id="ai-chat-window"
            class="hidden bg-white w-80 h-96 rounded-2xl shadow-2xl border border-gray-200 flex flex-col mb-4 overflow-hidden transition-all transform origin-bottom-right">
            <!-- Header -->
            <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-4 flex justify-between items-center text-white">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-robot"></i>
                    <span class="font-bold text-sm">euGENIO üßû‚Äç‚ôÇÔ∏è</span>
                </div>
                <button id="close-chat-btn" class="hover:text-gray-200 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <!-- Messages Area -->
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-gray-50 space-y-3 text-sm">
                <!-- Welcome Message dynamically added -->
            </div>

            <!-- Input Area -->
            <div class="p-3 bg-white border-t border-gray-100">
                <form id="chat-form" class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="Scrivi una domanda..."
                        class="flex-1 p-2 border border-gray-300 rounded-lg text-sm text-gray-900 bg-white focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                    <button type="submit"
                        class="bg-purple-600 text-white p-2 rounded-lg hover:bg-purple-700 transition shadow-sm disabled:opacity-50">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- Toggle Button -->
        <button id="toggle-chat-btn"
            class="bg-gradient-to-r from-purple-600 to-blue-600 text-white w-14 h-14 rounded-full shadow-lg hover:shadow-xl transition transform hover:scale-105 flex items-center justify-center text-2xl">
            <i class="fa-solid fa-comment-dots"></i>
        </button>
    </div>

    <script type="module" src="js/app.js?v=3.5.7"></script>
    <script src="js/pwa.js?v=3.5.3"></script>
</body>

</html>